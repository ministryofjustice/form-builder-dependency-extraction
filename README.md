# Form Builder Text Mining

This repo contains scripts used for extracting and mining text from live HMCTS forms.

## Text extraction

### Use text_extraction_and_file_format_investigation.ipynb

The output of this script is one .txt file per input PDF / Word document.

1. Set the `rootdir` and `extraction_file_path` variables to target your PDF and Word files (note that these are set in two different locations).
2. Execute the script in ipython notebook.
3. Look for feedback on the number of failed extractions and the number of Word vs PDF files.
NB.  I have not put any effort into optimising the extraction of text, since I had a few thousand forms to work with and only a 6-7 failures were observed.

## Finding forms that require attachments

### Use find_attachments.R

The output of this script is three .csv files of potential hits, for screening by a human.  Three lists are generated because we look for three different terms.  These could be combined into one list.

1. Set the variables at the top of the script to point the script at the correct directory and set the regex patterns.
2. Execute the script using R Studio or `Rscript find_attachments.R` in the terminal.
NB.  You might get a lot of potential hits here.  See below for some help.

## Refining attachment detecttion

### Use refine_attachment_detection.R

The aim is to reduce the number of potential hits that require further validation.  Alternatively, you could build this functionality into the original detect_attachments.R script.

First duplicated potential hits are removed (I.e. where `short_text` is the same), then some automatic screening is performed.

1. Run the script, pointing at <agency>_attachment.csv to generate a shorter list of potential hits for screening.
2. Use the reduced list for manual screening.

## Extrapolating validated attachments

### Use extrapolate_attachment_validations.R

This script extrapolates the output of manual screening using the refined list of potential hits.

### Manual screening

Use the output from refine_attachment_validations.R and find_attachments.R, marking each potential hit as either TRUE or FALSE in a column called 'required'.

## Match attachments

### Use match_attachments.R

For each form, this script takes the corresponding values in <agency>_attachments.csv / <agency>_enclosed.csv / <agency>_supporting.csv and if any are TRUE, the form requires an attachment.  The output is matched against the register.

## Finding references from one form to another

### Use find_references.R

This script uses a list of form codes to detect references from one form to another in the extracted text of each form.  The output is a table of references and a table of links between forms, which is used in the Shiny application.

1. `source()` the file in an R console
2. Run 'get_mapping_json(list_of_starting_forms, path_to_links_csv, reference_direction, number_of_iterations)'

## Shiny application, with D3 visualisation.

### Dependencies (data)
* links.csv (generated by find_references.R)
* register.csv (exported from [here](https://docs.google.com/spreadsheets/d/1EFGJXdSQzemCf42hP61JgTGan_OwgyXofkt7xRFdS7k/edit#gid=1904690115))

### Running the application
```sh
# in the shiny_app subdirectory
R -e "library(shiny); runApp()"
```

### Deploying the application
The first iterations were deployed to Edward Andress' shinyapps.io account.  You'll need to either set up your own account there or find another solution.  Deployment to shinyapps.io is simple and hosting is free (for 30 active hours).
```sh
# in the shiny_app subdirectory
R -e (library(shiny); library(rsconnect); deployApp())
```
